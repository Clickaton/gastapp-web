<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title th:text="${account.id != null ? 'Editar cuenta' : 'Nueva cuenta'} + ' — gastAPP'">Cuenta — gastAPP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
  <link th:href="@{/css/style.css}" rel="stylesheet"/>
  <link th:href="@{/css/categories-form.css}" rel="stylesheet"/>
</head>
<body>
  <nav th:replace="~{fragments/navbar :: nav}"></nav>
  <main class="container py-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
      <h1 class="page-title mb-0" th:text="${account.id != null ? 'Editar cuenta' : 'Nueva cuenta'}">Nueva cuenta</h1>
      <a th:href="@{/accounts}" class="btn btn-outline-secondary">Volver</a>
    </div>

    <div class="card card-gastapp card-category-form">
      <div class="card-body p-4">
        <form th:action="@{/accounts/save}" th:object="${account}" method="post" id="accountForm"
              th:attr="data-default-color=${account.color != null and !account.color.isEmpty() ? (account.color.startsWith('#') ? account.color : '#' + account.color) : '#6c757d'}, data-default-icono=${account.icono != null ? account.icono : ''}">
          <input th:if="${account.id != null}" type="hidden" th:field="*{id}"/>
          <input type="hidden" th:field="*{color}" th:id="'colorValue'"/>
          <input type="hidden" th:field="*{icono}" th:id="'iconoValue'"/>

          <div class="row g-4">
            <div class="col-12 col-md-6">
              <label class="form-label">Nombre *</label>
              <input type="text" th:field="*{nombre}" id="nombreInput" class="form-control" placeholder="Ej. Banco Nación, Efectivo" required maxlength="100"/>
              <p th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}" class="text-danger small mt-1"></p>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Tipo *</label>
              <select th:field="*{tipo}" class="form-select" required>
                <option value="">Elegir tipo</option>
                <option th:each="t : ${accountTypes}" th:value="${t}" th:text="${t}">Tipo</option>
              </select>
              <p th:if="${#fields.hasErrors('tipo')}" th:errors="*{tipo}" class="text-danger small mt-1"></p>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Saldo inicial *</label>
              <input type="number" th:field="*{saldoInicial}" class="form-control" step="0.01" min="0" required/>
              <p class="small text-muted mt-1">Saldo con el que empezás esta cuenta.</p>
              <p th:if="${#fields.hasErrors('saldoInicial')}" th:errors="*{saldoInicial}" class="text-danger small mt-1"></p>
            </div>

            <div class="col-12">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="shared" th:field="*{shared}">
                <label class="form-check-label" for="shared">Cuenta Compartida</label>
              </div>
            </div>

            <div class="col-12 col-md-6" id="sharedEmailGroup" style="display: none;">
              <label class="form-label">Email del usuario a compartir</label>
              <input type="email" th:field="*{sharedUserEmail}" class="form-control" placeholder="usuario@email.com"/>
              <p class="small text-muted mt-1">Ingresá el email del usuario con quien querés compartir esta cuenta.</p>
            </div>

            <div class="col-12">
              <label class="form-label">Vista previa</label>
              <div class="category-preview" id="accountPreview">
                <span class="category-preview-text" id="previewText">Nombre de la cuenta</span>
              </div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Color</label>
              <div class="color-picker-wrapper d-flex align-items-center gap-3 flex-wrap">
                <input type="color" id="colorPicker" class="color-picker-input" value="#6c757d" title="Elegir color"/>
                <input type="text" id="colorHex" class="form-control form-control-sm color-hex-input" placeholder="#6c757d" maxlength="7" title="Código hexadecimal"/>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Icono</label>
              <p class="small text-muted mb-2">Elegí un icono haciendo clic.</p>
              <div class="icon-grid" id="iconGrid">
                <button type="button" class="icon-option" data-icon="" title="Sin icono"><span class="no-icon">—</span></button>
                <button type="button" class="icon-option" data-icon="bi-wallet2" title="Billetera"><i class="bi bi-wallet2"></i></button>
                <button type="button" class="icon-option" data-icon="bi-bank" title="Banco"><i class="bi bi-bank"></i></button>
                <button type="button" class="icon-option" data-icon="bi-cash-stack" title="Efectivo"><i class="bi bi-cash-stack"></i></button>
                <button type="button" class="icon-option" data-icon="bi-credit-card" title="Tarjeta"><i class="bi bi-credit-card"></i></button>
                <button type="button" class="icon-option" data-icon="bi-piggy-bank" title="Alcancía"><i class="bi bi-piggy-bank"></i></button>
                <button type="button" class="icon-option" data-icon="bi-phone" title="Mercado Pago"><i class="bi bi-phone"></i></button>
                <button type="button" class="icon-option" data-icon="bi-briefcase" title="Caja"><i class="bi bi-briefcase"></i></button>
                <button type="button" class="icon-option" data-icon="bi-safe2" title="Caja fuerte"><i class="bi bi-safe2"></i></button>
                <button type="button" class="icon-option" data-icon="bi-coin" title="Monedas"><i class="bi bi-coin"></i></button>
              </div>
            </div>
          </div>

          <div class="mt-4 d-flex gap-2">
            <button type="submit" class="btn btn-gastapp">Guardar</button>
            <a th:href="@{/accounts}" class="btn btn-outline-secondary">Cancelar</a>
          </div>
        </form>
      </div>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function() {
      const form = document.getElementById('accountForm');
      const defaultColor = (form && form.getAttribute('data-default-color')) ? form.getAttribute('data-default-color') : '#6c757d';
      const defaultIcono = (form && form.getAttribute('data-default-icono')) ? form.getAttribute('data-default-icono') : '';

      const colorPicker = document.getElementById('colorPicker');
      const colorValue = document.getElementById('colorValue');
      const colorHex = document.getElementById('colorHex');
      const previewText = document.getElementById('previewText');
      const accountPreview = document.getElementById('accountPreview');
      const nombreInput = document.getElementById('nombreInput');
      const iconoValue = document.getElementById('iconoValue');
      const iconGrid = document.getElementById('iconGrid');
      const sharedCheckbox = document.getElementById('shared');
      const sharedEmailGroup = document.getElementById('sharedEmailGroup');

      function toggleSharedEmail() {
        if (sharedCheckbox && sharedEmailGroup) {
          sharedEmailGroup.style.display = sharedCheckbox.checked ? 'block' : 'none';
        }
      }

      if (sharedCheckbox) {
        sharedCheckbox.addEventListener('change', toggleSharedEmail);
        toggleSharedEmail(); // Initial state
      }

      function applyColor(color) {
        if (!color || !color.trim()) color = '#6c757d';
        color = color.trim().startsWith('#') ? color.trim() : '#' + color.trim();
        colorPicker.value = color.length === 7 ? color : '#6c757d';
        colorValue.value = colorPicker.value;
        colorHex.value = colorPicker.value;
        if (previewText) previewText.style.color = colorPicker.value;
        if (accountPreview) accountPreview.style.borderColor = colorPicker.value;
      }

      colorPicker.value = defaultColor.length === 7 ? defaultColor : '#6c757d';
      colorValue.value = colorPicker.value;
      colorHex.value = colorPicker.value;
      if (previewText) previewText.style.color = colorPicker.value;
      if (accountPreview) accountPreview.style.borderColor = colorPicker.value;

      colorPicker.addEventListener('input', function() {
        colorValue.value = this.value;
        colorHex.value = this.value;
        if (previewText) previewText.style.color = this.value;
        if (accountPreview) accountPreview.style.borderColor = this.value;
      });

      colorHex.addEventListener('change', function() {
        if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) applyColor(this.value);
      });

      if (nombreInput) {
        nombreInput.addEventListener('input', function() {
          previewText.textContent = this.value.trim() || 'Nombre de la cuenta';
        });
        previewText.textContent = nombreInput.value.trim() || 'Nombre de la cuenta';
      }

      iconoValue.value = defaultIcono;
      iconGrid.querySelectorAll('.icon-option').forEach(function(btn) {
        if (btn.dataset.icon === defaultIcono) btn.classList.add('active');
        btn.addEventListener('click', function() {
          iconGrid.querySelectorAll('.icon-option').forEach(function(b) { b.classList.remove('active'); });
          this.classList.add('active');
          iconoValue.value = this.dataset.icon || '';
        });
      });
    })();
  </script>
</body>
</html>
