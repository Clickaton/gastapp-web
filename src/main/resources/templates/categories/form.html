<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title th:text="${category.id != null ? 'Editar categoría' : 'Nueva categoría'} + ' — gastAPP'">Categoría — gastAPP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
  <link th:href="@{/css/style.css}" rel="stylesheet"/>
  <link th:href="@{/css/categories-form.css}" rel="stylesheet"/>
</head>
<body>
  <nav th:replace="~{fragments/navbar :: nav}"></nav>
  <main class="container py-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
      <h1 class="page-title mb-0" th:text="${category.id != null ? 'Editar categoría' : 'Nueva categoría'}">Nueva categoría</h1>
      <a th:href="@{/categories}" class="btn btn-outline-secondary">Volver</a>
    </div>

    <div class="card card-gastapp card-category-form">
      <div class="card-body p-4">
        <form th:action="@{/categories/save}" th:object="${category}" method="post" id="categoryForm"
              th:attr="data-default-color=${category.color != null and !category.color.isEmpty() ? (category.color.startsWith('#') ? category.color : '#' + category.color) : '#6c757d'}, data-default-icono=${category.icono != null ? category.icono : ''}">
          <input th:if="${category.id != null}" type="hidden" th:field="*{id}"/>
          <input type="hidden" th:field="*{color}" th:id="'colorValue'"/>
          <input type="hidden" th:field="*{icono}" th:id="'iconoValue'"/>

          <div class="row g-4">
            <div class="col-12">
              <label class="form-label">Nombre *</label>
              <input type="text" th:field="*{nombre}" id="nombreInput" class="form-control" placeholder="Ej. Comida, Transporte" required maxlength="100"/>
              <p th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}" class="text-danger small mt-1"></p>
            </div>

            <div class="col-12">
              <label class="form-label">Vista previa</label>
              <div class="category-preview" id="categoryPreview">
                <span class="category-preview-text" id="previewText">Nombre de la categoría</span>
              </div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Color</label>
              <div class="color-picker-wrapper d-flex align-items-center gap-3 flex-wrap">
                <input type="color" id="colorPicker" class="color-picker-input" value="#6c757d" title="Elegir color"/>
                <input type="text" id="colorHex" class="form-control form-control-sm color-hex-input" placeholder="#6c757d" maxlength="7" title="Código hexadecimal"/>
              </div>
              <p class="small text-muted mt-1">El color se aplica a la categoría en listados y gastos.</p>
            </div>

            <div class="col-12">
              <label class="form-label">Icono</label>
              <p class="small text-muted mb-2">Elegí un icono haciendo clic (se marca con borde).</p>
              <div class="icon-grid" id="iconGrid">
                <button type="button" class="icon-option" data-icon="" title="Sin icono"><span class="no-icon">—</span></button>
                <button type="button" class="icon-option" data-icon="bi-cart-fill" title="Carrito"><i class="bi bi-cart-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-cash-stack" title="Dinero"><i class="bi bi-cash-stack"></i></button>
                <button type="button" class="icon-option" data-icon="bi-house-fill" title="Casa"><i class="bi bi-house-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-car-front-fill" title="Auto"><i class="bi bi-car-front-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-heart-fill" title="Salud"><i class="bi bi-heart-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-bag-fill" title="Compras"><i class="bi bi-bag-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-cup-hot-fill" title="Café"><i class="bi bi-cup-hot-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-hospital-fill" title="Salud"><i class="bi bi-hospital-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-bus-front-fill" title="Transporte"><i class="bi bi-bus-front-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-phone-fill" title="Teléfono"><i class="bi bi-phone-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-gift-fill" title="Regalos"><i class="bi bi-gift-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-credit-card-fill" title="Tarjeta"><i class="bi bi-credit-card-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-egg-fill" title="Comida"><i class="bi bi-egg-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-shop" title="Tienda"><i class="bi bi-shop"></i></button>
                <button type="button" class="icon-option" data-icon="bi-droplet-fill" title="Servicios"><i class="bi bi-droplet-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-wifi" title="Internet"><i class="bi bi-wifi"></i></button>
                <button type="button" class="icon-option" data-icon="bi-book-fill" title="Educación"><i class="bi bi-book-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-palette-fill" title="Ocio"><i class="bi bi-palette-fill"></i></button>
              </div>
            </div>
          </div>

          <div class="mt-4 d-flex gap-2">
            <button type="submit" class="btn btn-gastapp">Guardar</button>
            <a th:href="@{/categories}" class="btn btn-outline-secondary">Cancelar</a>
          </div>
        </form>
      </div>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function() {
      const form = document.getElementById('categoryForm');
      const defaultColor = (form && form.getAttribute('data-default-color')) ? form.getAttribute('data-default-color') : '#6c757d';
      const defaultIcono = (form && form.getAttribute('data-default-icono')) ? form.getAttribute('data-default-icono') : '';

      const colorPicker = document.getElementById('colorPicker');
      const colorValue = document.getElementById('colorValue');
      const colorHex = document.getElementById('colorHex');
      const previewText = document.getElementById('previewText');
      const categoryPreview = document.getElementById('categoryPreview');
      const nombreInput = document.getElementById('nombreInput');
      const iconoValue = document.getElementById('iconoValue');
      const iconGrid = document.getElementById('iconGrid');

      function normalizeHex(val) {
        if (!val || !val.trim()) return '#6c757d';
        val = val.trim();
        return val.startsWith('#') ? val : '#' + val;
      }

      function applyColor(color) {
        color = normalizeHex(color);
        colorPicker.value = color.length === 7 ? color : '#6c757d';
        colorValue.value = colorPicker.value;
        colorHex.value = colorPicker.value;
        if (previewText) previewText.style.color = colorPicker.value;
        if (categoryPreview) categoryPreview.style.borderColor = colorPicker.value;
      }

      colorPicker.value = defaultColor.length === 7 ? defaultColor : '#6c757d';
      colorValue.value = colorPicker.value;
      colorHex.value = colorPicker.value;
      if (previewText) previewText.style.color = colorPicker.value;
      if (categoryPreview) categoryPreview.style.borderColor = colorPicker.value;

      colorPicker.addEventListener('input', function() {
        colorValue.value = this.value;
        colorHex.value = this.value;
        if (previewText) previewText.style.color = this.value;
        if (categoryPreview) categoryPreview.style.borderColor = this.value;
      });

      colorHex.addEventListener('input', function() {
        if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
          colorPicker.value = this.value;
          colorValue.value = this.value;
          if (previewText) previewText.style.color = this.value;
          if (categoryPreview) categoryPreview.style.borderColor = this.value;
        }
      });
      colorHex.addEventListener('change', function() {
        applyColor(this.value);
      });

      if (nombreInput) {
        nombreInput.addEventListener('input', function() {
          previewText.textContent = this.value.trim() || 'Nombre de la categoría';
        });
        previewText.textContent = nombreInput.value.trim() || 'Nombre de la categoría';
      }

      iconoValue.value = defaultIcono;
      iconGrid.querySelectorAll('.icon-option').forEach(function(btn) {
        if (btn.dataset.icon === defaultIcono) btn.classList.add('active');
        btn.addEventListener('click', function() {
          iconGrid.querySelectorAll('.icon-option').forEach(function(b) { b.classList.remove('active'); });
          this.classList.add('active');
          iconoValue.value = this.dataset.icon || '';
        });
      });
    })();
  </script>
</body>
</html>
