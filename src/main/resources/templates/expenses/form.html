<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title th:text="${expense.id != null ? 'Editar gasto' : 'Nuevo gasto'} + ' — gastAPP'">Gasto — gastAPP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
  <link th:href="@{/css/style.css}" rel="stylesheet"/>
  <link th:href="@{/css/categories-form.css}" rel="stylesheet"/>
</head>
<body>
  <nav th:replace="~{fragments/navbar :: nav}"></nav>
  <main class="container py-4">
    <div th:if="${warning}" class="alert alert-warning alert-gastapp alert-dismissible fade show">
      <span th:text="${warning}"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
      <h1 class="page-title mb-0" th:text="${expense.id != null ? 'Editar gasto' : 'Nuevo gasto'}">Nuevo gasto</h1>
      <a th:href="@{/expenses}" class="btn btn-outline-secondary">Volver</a>
    </div>

    <div class="card card-gastapp card-category-form">
      <div class="card-body p-4">
        <form th:action="@{/expenses/save}" th:object="${expense}" method="post" id="expenseForm"
              th:attr="data-default-color=${expense.color != null and !expense.color.isEmpty() ? (expense.color.startsWith('#') ? expense.color : '#' + expense.color) : '#6c757d'}, data-default-icono=${expense.icono != null ? expense.icono : ''}">
          <input th:if="${expense.id != null}" type="hidden" th:field="*{id}"/>
          <input type="hidden" th:field="*{color}" th:id="'colorValue'"/>
          <input type="hidden" th:field="*{icono}" th:id="'iconoValue'"/>

          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Monto *</label>
              <input type="number" th:field="*{monto}" class="form-control" step="0.01" min="0.01" required/>
              <p th:if="${#fields.hasErrors('monto')}" th:errors="*{monto}" class="text-danger small mt-1"></p>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Fecha *</label>
              <input type="date" th:field="*{fecha}" class="form-control" required/>
              <p th:if="${#fields.hasErrors('fecha')}" th:errors="*{fecha}" class="text-danger small mt-1"></p>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Categoría *</label>
              <select th:field="*{categoryId}" class="form-select" required>
                <option value="">Elegir categoría</option>
                <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.nombre}">Categoría</option>
              </select>
              <p th:if="${#fields.hasErrors('categoryId')}" th:errors="*{categoryId}" class="text-danger small mt-1"></p>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Cuenta *</label>
              <select th:field="*{accountId}" class="form-select" required>
                <option value="">Elegir cuenta</option>
                <option th:each="a : ${accounts}" th:value="${a.id}" th:text="${a.nombre}">Cuenta</option>
              </select>
              <p th:if="${#fields.hasErrors('accountId')}" th:errors="*{accountId}" class="text-danger small mt-1"></p>
            </div>
            <!-- Sección de Cuotas -->
            <div class="col-12">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" th:field="*{esCuotas}" id="esCuotas">
                    <label class="form-check-label" for="esCuotas">
                        Compra en cuotas
                    </label>
                </div>
            </div>
            <div class="col-12 col-md-6" id="cuotasSection" style="display: none;">
                <label class="form-label">Cantidad de Cuotas</label>
                <input type="number" th:field="*{totalCuotas}" class="form-control" min="2" max="100">
            </div>

            <div class="col-12">
              <label class="form-label">Descripción</label>
              <input type="text" th:field="*{descripcion}" class="form-control" placeholder="Opcional" maxlength="500"/>
            </div>

            <!-- Color Selection -->
            <div class="col-12 col-md-6">
              <label class="form-label">Color</label>
              <div class="color-picker-wrapper d-flex align-items-center gap-3 flex-wrap">
                <input type="color" id="colorPicker" class="color-picker-input" value="#6c757d" title="Elegir color"/>
                <input type="text" id="colorHex" class="form-control form-control-sm color-hex-input" placeholder="#6c757d" maxlength="7" title="Código hexadecimal"/>
              </div>
            </div>

            <!-- Icon Selection -->
            <div class="col-12">
              <label class="form-label">Icono</label>
              <p class="small text-muted mb-2">Elegí un icono para este gasto (opcional).</p>
              <div class="icon-grid" id="iconGrid">
                <button type="button" class="icon-option" data-icon="" title="Sin icono"><span class="no-icon">—</span></button>
                <button type="button" class="icon-option" data-icon="bi-cart-fill" title="Carrito"><i class="bi bi-cart-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-cash-stack" title="Dinero"><i class="bi bi-cash-stack"></i></button>
                <button type="button" class="icon-option" data-icon="bi-house-fill" title="Casa"><i class="bi bi-house-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-car-front-fill" title="Auto"><i class="bi bi-car-front-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-heart-fill" title="Salud"><i class="bi bi-heart-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-bag-fill" title="Compras"><i class="bi bi-bag-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-cup-hot-fill" title="Café"><i class="bi bi-cup-hot-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-hospital-fill" title="Salud"><i class="bi bi-hospital-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-bus-front-fill" title="Transporte"><i class="bi bi-bus-front-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-phone-fill" title="Teléfono"><i class="bi bi-phone-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-gift-fill" title="Regalos"><i class="bi bi-gift-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-credit-card-fill" title="Tarjeta"><i class="bi bi-credit-card-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-egg-fill" title="Comida"><i class="bi bi-egg-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-shop" title="Tienda"><i class="bi bi-shop"></i></button>
                <button type="button" class="icon-option" data-icon="bi-droplet-fill" title="Servicios"><i class="bi bi-droplet-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-wifi" title="Internet"><i class="bi bi-wifi"></i></button>
                <button type="button" class="icon-option" data-icon="bi-book-fill" title="Educación"><i class="bi bi-book-fill"></i></button>
                <button type="button" class="icon-option" data-icon="bi-palette-fill" title="Ocio"><i class="bi bi-palette-fill"></i></button>
              </div>
            </div>
          </div>
          <div class="mt-4 d-flex gap-2">
            <button type="submit" class="btn btn-gastapp">Guardar</button>
            <a th:href="@{/expenses}" class="btn btn-outline-secondary">Cancelar</a>
          </div>
        </form>
      </div>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Installments Logic
        const esCuotasCheck = document.getElementById('esCuotas');
        const cuotasSection = document.getElementById('cuotasSection');

        function toggleCuotas() {
            if (esCuotasCheck.checked) {
                cuotasSection.style.display = 'block';
            } else {
                cuotasSection.style.display = 'none';
            }
        }

        if (esCuotasCheck) {
            esCuotasCheck.addEventListener('change', toggleCuotas);
            toggleCuotas();
        }

        // Color & Icon Logic
        const form = document.getElementById('expenseForm');
        const defaultColor = (form && form.getAttribute('data-default-color')) ? form.getAttribute('data-default-color') : '#6c757d';
        const defaultIcono = (form && form.getAttribute('data-default-icono')) ? form.getAttribute('data-default-icono') : '';

        const colorPicker = document.getElementById('colorPicker');
        const colorValue = document.getElementById('colorValue');
        const colorHex = document.getElementById('colorHex');
        const iconoValue = document.getElementById('iconoValue');
        const iconGrid = document.getElementById('iconGrid');

        function normalizeHex(val) {
            if (!val || !val.trim()) return '#6c757d';
            val = val.trim();
            return val.startsWith('#') ? val : '#' + val;
        }

        function applyColor(color) {
            color = normalizeHex(color);
            colorPicker.value = color.length === 7 ? color : '#6c757d';
            colorValue.value = colorPicker.value;
            colorHex.value = colorPicker.value;
        }

        colorPicker.value = defaultColor.length === 7 ? defaultColor : '#6c757d';
        colorValue.value = colorPicker.value;
        colorHex.value = colorPicker.value;

        colorPicker.addEventListener('input', function() {
            colorValue.value = this.value;
            colorHex.value = this.value;
        });

        colorHex.addEventListener('input', function() {
            if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
                colorPicker.value = this.value;
                colorValue.value = this.value;
            }
        });
        colorHex.addEventListener('change', function() {
            applyColor(this.value);
        });

        iconoValue.value = defaultIcono;
        iconGrid.querySelectorAll('.icon-option').forEach(function(btn) {
            if (btn.dataset.icon === defaultIcono) btn.classList.add('active');
            btn.addEventListener('click', function() {
                iconGrid.querySelectorAll('.icon-option').forEach(function(b) { b.classList.remove('active'); });
                this.classList.add('active');
                iconoValue.value = this.dataset.icon || '';
            });
        });
    });
  </script>
</body>
</html>
